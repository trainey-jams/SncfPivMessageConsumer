using Apache.NMS;
using Apache.NMS.ActiveMQ.Commands;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using NSubstitute;
using SncfPivMessageConsumer.App;
using SncfPivMessageConsumer.Channels;
using SncfPivMessageConsumer.Mappers;
using SncfPivMessageConsumer.Models;
using SncfPivMessageConsumer.Models.Config;
using SncfPivMessageConsumer.OpenWire;
using SncfPivMessageConsumer_AcceptanceTests.Stubs;
using System.Text;
using System.Threading.Channels;
using Trainline.Extensions.Logging.Core;
using Trainline.Extensions.Logging.Providers.Serilog.Extensions;

namespace SncfPivMessageConsumer_AcceptanceTests
{
    public class AcceptanceTests
    {
        private ILoggerFactory LoggerFactory;
        private ActiveMQMessage MessageToTest;
        private ILogger<AcceptanceTests> MessageAcknowledgementSubs;

        public AcceptanceTests() 
        {
           // LoggerFactory = InitLoggerFactory();
            MessageToTest = InitMessage();
        }

        /// <summary>
        /// Attempts to process a single mocked message from ingestion through to publication to SNS.
        /// Verification via logs and message acknowledger being called. 
        /// </summary>
        [Fact]
        public async Task MessageServiceSingleRun()
        {
            MessageAcknowledgementSubs = Substitute.For<ILogger<AcceptanceTests>>();
            var logger = Substitute.For<ILogger<MessageService>>();
            var channel = Channel.CreateBounded<ActiveMQMessageWrapper>(1);
            var config = Options.Create(new MessageServiceConfig() { MaxParallelConsumers = 1 });

            var service = new MessageService(logger, config, GetChannelProducer(), GetChannelConsumer(), channel);

            var tokenSource = new CancellationTokenSource();
            tokenSource.CancelAfter(TimeSpan.FromSeconds(10));

            await service.StartAsync(tokenSource.Token);

            logger.Received().LogInformation("Starting message service.");
            logger.Received().LogInformation("Message service shutting down.");
            MessageAcknowledgementSubs.Received().LogInformation("Message Acknowledger was called.");
        }

        private ChannelProducer GetChannelProducer()
        {
            var serviceContext = new ServiceContext(); 
            var consumerFactoryMock = Substitute.For<IOpenWireConsumerFactory>();
            var logger = Substitute.For<ILogger<ChannelProducer>>();
            var consumerMock = Substitute.For<IMessageConsumer>();
            
            ChannelProducer channelProducer = new ChannelProducer(serviceContext, logger, consumerFactoryMock);

            consumerFactoryMock.GetMessageConsumer().Returns(consumerMock);
            
            consumerMock.ReceiveAsync().Returns(MessageToTest);

            return channelProducer;
        }

        private ChannelConsumer GetChannelConsumer()
        {
            var logger = Substitute.For<ILogger<ChannelConsumer>>();
            
            var pivMapper = new PivMapper();

            var snsRepo = new SnsRepoStub();

            ChannelConsumer channelConsumer = new ChannelConsumer(logger, pivMapper, snsRepo);

            return channelConsumer;
        }

        private ActiveMQMessage InitMessage()
        {
            var msg = Substitute.For<ActiveMQMessage>();

            msg.Expiration = 1111;
            msg.Priority = 0;
            msg.BrokerInTime = 1709895196;
            msg.BrokerOutTime = 1709895198;
            msg.Expiration = 1709895300;
            msg.MessageId = new MessageId("ID:piv-service-circulationenrichie-v2-api-0-39865-1709839690651-1:351:570:1:13:14258932");
            msg.Content = Encoding.UTF8.GetBytes("{\"messageTime\":\"2024-03-08T12:46:31.680Z\",\"objects\":[{\"objectId\":\"e4e9d180a3d9fdb72f934f4801d32dda\",\"object\":{\"origine\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.47376031,\"coordYLat\":48.61440464,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91100\",\"codeINSEE\":\"91174\",\"libelle\":\"Corbeil-Essonnes\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"ac744577-ee91-6121-86ad-d20a469d194e\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRCOE\"},{\"type\":\"UIC\",\"valeur\":\"87681007\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681007-BV\"},{\"type\":\"TT0020\",\"valeur\":\"COE\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681007\",\"libelle\":\"Corbeil-Essonnes\",\"type\":\"ZONE_ARRET\"},\"destination\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.38267,\"coordYLat\":48.68917,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91260\",\"codeINSEE\":\"91326\",\"libelle\":\"Juvisy-sur-Orge\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"57834a08-41ce-1f83-b843-bf20ea393493\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRJSY\"},{\"type\":\"UIC\",\"valeur\":\"87545244\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-545244-BV\"},{\"type\":\"TT0020\",\"valeur\":\"JY\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"34\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87545244\",\"libelle\":\"Juvisy\",\"type\":\"ZONE_ARRET\"},\"listeArretsDesserte\":{\"arret\":[{\"depart\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":true,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:36:00+01:00\",\"dateHeureReelle\":\"2024-03-08T13:37:22+01:00\",\"dateHeureInterne\":\"2024-03-08T13:37:22+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.47376031,\"coordYLat\":48.61440464,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91100\",\"codeINSEE\":\"91174\",\"libelle\":\"Corbeil-Essonnes\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"ac744577-ee91-6121-86ad-d20a469d194e\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRCOE\"},{\"type\":\"UIC\",\"valeur\":\"87681007\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681007-BV\"},{\"type\":\"TT0020\",\"valeur\":\"COE\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681007\",\"libelle\":\"Corbeil-Essonnes\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"14\"},\"voie\":{\"numeroQuai\":\"14\",\"numero\":\"14\"},\"rang\":0,\"rangInterne\":0,\"indicateurDescenteInterdite\":true},{\"arrivee\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":false,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:39:10+01:00\",\"dateHeureReelle\":\"2024-03-08T13:45:10+01:00\",\"dateHeureInterne\":\"2024-03-08T13:45:10+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"depart\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":true,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:40:00+01:00\",\"dateHeureReelle\":\"2024-03-08T13:41:22+01:00\",\"dateHeureInterne\":\"2024-03-08T13:41:22+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.45209,\"coordYLat\":48.63442,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91000,91080\",\"codeINSEE\":\"91228\",\"libelle\":\"Évry-Courcouronnes\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"8bc3a337-8b68-2192-bc90-b85392592b96\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRGKX\"},{\"type\":\"UIC\",\"valeur\":\"87681361\"},{\"type\":\"codeLocaliteSNCF\",\"valeur\":\"FRJEV\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681361-00\"},{\"type\":\"TT0020\",\"valeur\":\"EVR\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681361\",\"libelle\":\"Évry\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"1\"},\"voie\":{\"numeroQuai\":\"1\",\"numero\":\"2\"},\"rang\":1,\"rangInterne\":1,\"dureeStationnement\":0,\"dureeStationnementReelle\":0},{\"arrivee\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":false,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:42:30+01:00\",\"dateHeureReelle\":\"2024-03-08T13:43:28+01:00\",\"dateHeureInterne\":\"2024-03-08T13:43:28+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"depart\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":true,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:43:20+01:00\",\"dateHeureReelle\":\"2024-03-08T13:44:18+01:00\",\"dateHeureInterne\":\"2024-03-08T13:44:18+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.43616193,\"coordYLat\":48.64792399,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91130\",\"codeINSEE\":\"91521\",\"libelle\":\"Ris-Orangis\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"6cf802a1-6a3c-03aa-8af7-725b461db6c4\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRGKW\"},{\"type\":\"UIC\",\"valeur\":\"87681353\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681353-00\"},{\"type\":\"TT0020\",\"valeur\":\"GBG\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681353\",\"libelle\":\"Grand Bourg\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"1\"},\"voie\":{\"numeroQuai\":\"1\",\"numero\":\"2\"},\"rang\":2,\"rangInterne\":2,\"dureeStationnement\":0,\"dureeStationnementReelle\":0},{\"arrivee\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":false,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:45:50+01:00\",\"dateHeureReelle\":\"2024-03-08T13:46:23+01:00\",\"dateHeureInterne\":\"2024-03-08T13:46:23+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"depart\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":true,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:46:40+01:00\",\"dateHeureReelle\":\"2024-03-08T13:48:19+01:00\",\"dateHeureInterne\":\"2024-03-08T13:48:19+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.41443872,\"coordYLat\":48.65941116,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91130\",\"codeINSEE\":\"91521\",\"libelle\":\"Ris-Orangis\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"1bcdcbc4-c5c9-1af1-a133-6e91b47db973\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRGKU\"},{\"type\":\"UIC\",\"valeur\":\"87681338\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681338-BV\"},{\"type\":\"TT0020\",\"valeur\":\"RIS\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681338\",\"libelle\":\"Ris-Orangis\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"2\"},\"voie\":{\"numeroQuai\":\"2\",\"numero\":\"2\"},\"rang\":3,\"rangInterne\":3,\"dureeStationnement\":0,\"dureeStationnementReelle\":0},{\"arrivee\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":false,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:49:50+01:00\",\"dateHeureReelle\":\"2024-03-08T13:51:29+01:00\",\"dateHeureInterne\":\"2024-03-08T13:51:29+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"depart\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":true,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:50:30+01:00\",\"dateHeureReelle\":\"2024-03-08T13:52:09+01:00\",\"dateHeureInterne\":\"2024-03-08T13:52:09+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.38640695,\"coordYLat\":48.67612782,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91170\",\"codeINSEE\":\"91687\",\"libelle\":\"Viry-Châtillon\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"73e5a106-d709-b9c5-bf70-195616819a5d\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRGKS\"},{\"type\":\"UIC\",\"valeur\":\"87681312\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-681312-00\"},{\"type\":\"TT0020\",\"valeur\":\"VWC\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"50\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87681312\",\"libelle\":\"Viry-Châtillon\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"1\"},\"voie\":{\"numeroQuai\":\"1\",\"numero\":\"2\"},\"rang\":4,\"rangInterne\":4,\"dureeStationnement\":0,\"dureeStationnementReelle\":0},{\"arrivee\":{\"affichageIV\":{\"indicateurAffichableTableauxGare\":false,\"indicateurAffichableItineraire\":true,\"indicateurAffichableTrajetEnregistre\":true},\"composition\":{\"element\":[{\"voiture\":[{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"},{\"listePortes\":{\"porte\":[{\"position\":\"686\"}]},\"categorie\":\"\",\"longueur\":\"1373\"}],\"typeMateriel\":\"-Z\",\"serieMateriel\":\"-Z57000 110m 8C\",\"familleMateriel\":\"E\",\"libelleFamilleMateriel\":\"Automoteurs et Automotrices autres que TGV\",\"codeNature\":\"1\",\"libelleNature\":\"Commercial\",\"numeroAffectation\":\"139R\",\"rangElement\":\"0\",\"nomLivree\":\"blueIDFM\",\"imageLivree\":\"https://media.ivrc.vsct.fr/Livrees/Regio2N_blueIDFM_8C.png\",\"nomCommercial\":\"Regio2N\",\"nombreVoituresCommerciales\":\"8\",\"nombrePlacesAssises\":\"524\"}],\"nombreElements\":1},\"numeroCirculation\":\"158704\",\"numeroMarche\":\"158704\",\"dateHeure\":\"2024-03-08T13:54:50+01:00\",\"dateHeureReelle\":\"2024-03-08T13:56:29+01:00\",\"dateHeureInterne\":\"2024-03-08T13:56:29+01:00\",\"typeAffichage\":\"HORAIRE\",\"indicateurTempsReel\":true,\"planTransportSource\":\"PTA\"},\"emplacement\":{\"listeCoordonnees\":{\"coordonnees\":[{\"coordXLng\":2.38267,\"coordYLat\":48.68917,\"type\":\"WGS84\"}]},\"commune\":{\"codePostal\":\"91260\",\"codeINSEE\":\"91326\",\"libelle\":\"Juvisy-sur-Orge\"},\"departement\":{\"code\":\"91\",\"libelle\":\"Essonne\"},\"region\":{\"code\":\"11\",\"libelle\":\"Île-de-France\"},\"pays\":{\"code\":\"FRA\",\"libelle\":\"France\"},\"infosZoneArret\":{\"listeCodes\":{\"valeur\":[{\"type\":\"uuid\",\"valeur\":\"57834a08-41ce-1f83-b843-bf20ea393493\"},{\"type\":\"codeRESARAIL\",\"valeur\":\"FRJSY\"},{\"type\":\"UIC\",\"valeur\":\"87545244\"},{\"type\":\"codeCRCICH\",\"valeur\":\"0087-545244-BV\"},{\"type\":\"TT0020\",\"valeur\":\"JY\"},{\"type\":\"codeRegionSNCF\",\"valeur\":\"34\"}],\"typeDefaut\":\"UIC\"},\"indicateurSNCF\":true,\"indicateurMultimodal\":true,\"indicateurQuaisVoies\":false,\"indicateurTableauDeparts\":true,\"indicateurTableauArrivees\":false},\"code\":\"87545244\",\"libelle\":\"Juvisy\",\"type\":\"ZONE_ARRET\"},\"quai\":{\"numero\":\"49\"},\"voie\":{\"numeroQuai\":\"49\",\"numero\":\"49\"},\"rang\":5,\"rangInterne\":5,\"indicateurMonteeInterdite\":true}],\"nombreEscales\":4},\"affichageIV\":{\"indicateurAffichableDetailTrain\":true},\"operateur\":{\"codeOperateur\":\"1187\",\"libelleOperateur\":\"SNCF\"},\"modeTransport\":{\"codeMode\":\"rail\",\"libelleMode\":\"Ferré\",\"codeSousMode\":\"suburbanRailway\",\"libelleSousMode\":\"Train\",\"typeMode\":\"FERRE\"},\"marque\":{\"code\":\"TNRER\",\"libelle\":\"RER\"},\"parcours\":{\"route\":{\"ligne\":{\"modeTransport\":{\"codeMode\":\"rail\",\"libelleMode\":\"Ferré\",\"codeSousMode\":\"suburbanRailway\",\"libelleSousMode\":\"Train\",\"typeMode\":\"FERRE\"},\"operateur\":{\"codeOperateur\":\"1187\",\"libelleOperateur\":\"SNCF\"},\"presentation\":{\"codeCouleur\":\"#008B5B\"},\"marque\":{\"code\":\"TNRER\",\"libelle\":\"RER\"},\"plageTemporelleApplication\":{\"plageQuotidienne\":[{\"dateDebut\":\"2022-03-01\",\"dateFin\":\"2082-12-31\"}]},\"plageTemporellePublication\":{\"plageQuotidienne\":[{\"dateDebut\":\"2022-03-01\",\"dateFin\":\"2082-12-31\"}]},\"codeLigne\":\"D\",\"idLigne\":\"D\",\"libelleLigne\":\"D\"}}},\"numero\":\"158704\",\"numeroDestination\":\"158704\",\"codeCirculation\":\"e4e9d180a3d9fdb72f934f4801d32dda\",\"dateCirculation\":\"2024-03-08\",\"indicateurAdaptation\":false,\"natureTrain\":\"C\",\"codeMission\":\"JAVA\",\"dateDerniereModification\":\"2024-03-08T13:46:26+01:00\",\"planTransportSource\":\"PTA\",\"indicateurCourseDeReference\":true,\"codeTransporteurResponsable\":\"DIVISION_ALLIANCE/503\"},\"properties\":{\"circulation.listeArretDesserte.numeroCirculation[]\":[\"158704\"],\"circulation.indicateurCourseDeReference\":true,\"circulation.codeCirculation\":\"e4e9d180a3d9fdb72f934f4801d32dda\",\"circulation.planTransportSource\":\"PTA\",\"circulation.marque.code\":\"TNRER\",\"circulation.listeArretDesserte.arret[]\":[\"87681007\",\"87681361\",\"87681353\",\"87681338\",\"87681312\",\"87545244\"],\"circulation.evenement[]\":[],\"circulation.dateCirculation\":\"2024-03-08\",\"notificationTrigger\":\"circulation\",\"nbJoursAvantDateCirculation\":0,\"circulation.parcours.route.ligne.idLigne\":\"D\",\"circulation.operateur.codeOperateur\":\"1187\",\"circulation.codeMission\":\"JAVA\",\"circulation.modeTransport.codeMode\":\"rail\",\"circulation.modeTransport.typeMode\":\"FERRE\",\"circulation.codeTransporteurResponsable\":\"DIVISION_ALLIANCE/503\",\"circulation.indicateurAdaptation\":false,\"circulation.numero\":\"158704\",\"operation\":\"UPDATE\"},\"operation\":\"UPDATE\"}]}");

            msg.Acknowledger += Msg_Acknowledger;

            return msg;
        }

        private void Msg_Acknowledger(ActiveMQMessage message)
        {
            MessageAcknowledgementSubs.LogInformation("Message Acknowledger was called.");
        }
    }
}